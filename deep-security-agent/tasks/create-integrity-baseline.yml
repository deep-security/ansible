# Copyright 2018, Trend Micro
#
# License as per [repo](master/LICENSE)
#
# *********************************************************************
# * Create an integrity baseline for the current node
# *********************************************************************
---
# *********************************************************************
# * Check if DSA installed properly
# *********************************************************************
- debug:
    msg: "Check if DSA installed properly."

- stat:
    path: /opt/ds_agent/dsa_control
  register: dsaControl

- fail:
    msg: 
        - "Could not find command /opt/ds_agent/dsa_control to operate DSA."
        - "Please make sure Deep Security Agent has been installed"
  when: dsaControl.stat.size is not defined 

# *********************************************************************
# * Ask the Deep Security agent to create an integrity baseline
# *********************************************************************
- debug:
    msg: "Ask the Deep Security agent to create an integrity baseline" 

- shell: /opt/ds_agent/dsa_control --buildBaseline
  when: ansible_os_family != "Windows"
  become: true

- win_shell: "& 'C:\\Program Files\\Trend Micro\\Deep Security Agent\\dsa_control' --buildBaseline"
  when: ansible_os_family == "Windows"